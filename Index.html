<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Angle Gram Ultimate</title>
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@vapi-ai/web/dist/vapi.min.js"></script>

    <style>
        /* ðŸŽ¨ THEME */
        :root { --bg: #050510; --glass: rgba(20, 20, 35, 0.95); --neon: #00f2ea; --pink: #ff0055; --text: #e0fbfc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; overflow: hidden; user-select: none; }

        /* LAYOUT */
        #app-view { display: none; height: 100vh; flex-direction: column; }
        .header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--glass); border-bottom: 1px solid #333; position: relative; z-index: 100; }
        .screen { flex: 1; overflow-y: scroll; padding-bottom: 80px; display: none; }
        .screen.active { display: block; }

        /* LOGIN */
        #login-view { position: fixed; inset: 0; z-index: 5000; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .login-box { width: 90%; max-width: 350px; text-align: center; }
        .logo { font-size: 50px; font-weight: 900; background: linear-gradient(135deg, #fff, var(--neon)); -webkit-background-clip: text; color: transparent; margin-bottom: 30px; }
        .inp { width: 100%; padding: 15px; margin: 10px 0; background: rgba(255,255,255,0.1); border: 1px solid #333; color: white; border-radius: 12px; text-align: center; outline: none; }
        .btn { width: 100%; padding: 15px; background: var(--neon); border: none; font-weight: 800; border-radius: 12px; margin-top: 10px; color: #000; cursor: pointer; }
        .tabs { display: flex; margin-bottom: 20px; width: 100%; }
        .tab { flex: 1; padding: 10px; color: #666; border-bottom: 2px solid #333; }
        .tab.active { color: white; border-color: var(--neon); }

        /* PROFILE BUTTONS (FIXED) */
        .p-btn { 
            width: 100%; padding: 10px; margin-top: 15px; border-radius: 8px; border: none; 
            font-weight: bold; cursor: pointer; font-size: 14px; text-transform: uppercase;
        }
        .btn-fav { background: var(--neon); color: #000; box-shadow: 0 0 10px rgba(0, 242, 234, 0.3); }
        .btn-added { background: #333; color: #fff; border: 1px solid #555; }
        .btn-logout { background: #ff0055; color: #fff; }

        /* STORIES */
        .s-row { display: flex; gap: 15px; padding: 15px; overflow-x: auto; background: var(--bg); border-bottom: 1px solid #111; }
        .s-ring { width: 65px; height: 65px; border-radius: 50%; padding: 2px; border: 2px solid #333; position: relative; flex-shrink: 0; }
        .s-ring.active { border-color: transparent; background: linear-gradient(45deg, var(--neon), var(--pink)); }
        .s-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid #000; }
        
        /* POSTS */
        .post { margin-bottom: 20px; border-bottom: 1px solid #222; }
        .p-head { padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .p-av { width: 35px; height: 35px; border-radius: 50%; object-fit:cover; border: 1px solid var(--neon); }
        .p-img { width: 100%; height: auto; display: block; }
        .p-act { padding: 10px; display: flex; gap: 15px; font-size: 24px; }
        .liked { color: var(--pink); }

        /* PROFILE */
        .p-top { text-align: center; padding: 20px; }
        .p-pic { width: 90px; height: 90px; border-radius: 50%; border: 2px solid var(--neon); padding: 3px; object-fit:cover; }
        .stats { display: flex; justify-content: center; gap: 20px; margin: 15px 0; }
        
        /* AI BUTTON */
        .ai-btn { padding: 5px 12px; background: #333; border-radius: 20px; display: flex; align-items: center; gap: 5px; font-size: 12px; font-weight: bold; border: 1px solid #555; cursor: pointer; }
        .ai-dot { width: 8px; height: 8px; background: #666; border-radius: 50%; }
        .ai-active { border-color: #0f0; }
        .ai-active .ai-dot { background: #0f0; box-shadow: 0 0 5px #0f0; }

        /* NAV */
        .nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: var(--glass); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; z-index: 200; }
        .nav i { font-size: 26px; color: #666; transition: 0.2s; }
        .nav i.active { color: var(--neon); transform: translateY(-5px); }
        
        .modal { position: fixed; bottom: -100%; left: 0; width: 100%; background: #111; padding: 30px; border-radius: 20px 20px 0 0; transition: 0.3s; z-index: 300; border-top: 1px solid var(--neon); box-sizing: border-box; }
        .modal.open { bottom: 0; }
        .u-btn { flex: 1; padding: 10px; background: #222; border: 1px solid #333; color: #fff; border-radius: 8px; cursor: pointer; }
        .u-btn.sel { background: var(--neon); color: #000; font-weight: bold; }
        
        .user-row { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid #222; cursor: pointer; }
        .user-row img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--neon); }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="login-box">
            <div class="logo">ANGLE</div>
            <div class="tabs">
                <div class="tab active" id="t-mail" onclick="uiLogin('mail')">Email</div>
                <div class="tab" id="t-sms" onclick="uiLogin('sms')">Phone</div>
            </div>
            <div id="f-mail">
                <div id="e-s1"><input type="email" id="e-in" class="inp" placeholder="Email"><button onclick="sendE()" class="btn" id="b-e">Get Code</button></div>
                <div id="e-s2" style="display:none;"><input type="number" id="e-code" class="inp" placeholder="Code"><button onclick="verifyE()" class="btn">Login</button></div>
            </div>
            <div id="f-sms" style="display:none;">
                <div id="p-s1"><input type="tel" id="p-in" class="inp" placeholder="Mobile"><button onclick="sendP()" class="btn" id="b-p">Get OTP</button></div>
                <div id="p-s2" style="display:none;"><input type="number" id="p-code" class="inp" placeholder="OTP"><button onclick="verifyP()" class="btn">Login</button></div>
            </div>
        </div>
    </div>

    <div id="app-view">
        <div class="header">
            <i class="ri-arrow-left-line" id="back-btn" style="font-size:24px; display:none;" onclick="tab('home')"></i>
            <b style="font-size:20px;">Angle</b>
            <div class="ai-btn" onclick="toggleVapi()" id="vapi-btn">
                <div class="ai-dot"></div> AI BOSS
            </div>
        </div>

        <div id="home-screen" class="screen active">
            <div class="s-row" id="story-row">
                <div style="text-align:center; flex-shrink:0;" onclick="openUp('story')">
                    <div class="s-ring"><img id="my-s-img" class="s-img" src=""><div style="position:absolute;bottom:0;right:0;background:var(--neon);color:#000;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;">+</div></div>
                    <small style="font-size:10px; color:#aaa;">Add Story</small>
                </div>
            </div>
            <div id="feed"></div>
        </div>

        <div id="search-screen" class="screen">
            <div style="padding:15px; border-bottom:1px solid #333;">
                <input type="text" class="inp" style="margin:0; text-align:left; padding-left:20px;" placeholder="Search people..." oninput="doSearch(this.value)">
            </div>
            <div id="search-res"></div>
        </div>

        <div id="reels-screen" class="screen" style="background:#000;"></div>

        <div id="profile-screen" class="screen">
            <div class="p-top">
                <img id="p-pic" class="p-pic" src="">
                <h2 id="p-name">User</h2>
                
                <div class="stats">
                    <div><b id="s-posts">0</b><br><small>Posts</small></div>
                    <div><b id="s-fans">0</b><br><small>Fans</small></div>
                    <div><b id="s-favs">0</b><br><small>Favorites</small></div>
                </div>

                <div id="p-actions" style="width:100%;"></div>
            </div>
            <div id="p-grid" style="display:grid; grid-template-columns:repeat(3,1fr); gap:2px;"></div>
        </div>

        <div id="upload-modal" class="modal">
            <h3 style="text-align:center; color:var(--neon);">UPLOAD</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button onclick="setUType('post',this)" class="u-btn sel">Post</button>
                <button onclick="setUType('reel',this)" class="u-btn">Reel</button>
                <button onclick="setUType('story',this)" class="u-btn">Story</button>
            </div>
            <input type="file" id="u-file" class="inp">
            <input type="text" id="u-cap" class="inp" placeholder="Caption...">
            <button onclick="uploadNow()" class="btn">Upload Now</button>
            <p onclick="document.getElementById('upload-modal').classList.remove('open')" style="text-align:center; padding:15px; color:#666;">Cancel</p>
        </div>

        <div class="nav">
            <i class="ri-home-5-fill active" onclick="tab('home',this)"></i>
            <i class="ri-search-line" onclick="tab('search',this)"></i>
            <i class="ri-add-circle-fill" onclick="document.getElementById('upload-modal').classList.add('open')" style="font-size:45px; color:var(--neon); transform:translateY(-10px);"></i>
            <i class="ri-film-fill" onclick="tab('reels',this)"></i>
            <i class="ri-user-5-line" onclick="openProfile(myUser.id)"></i>
        </div>
    </div>

    <script>
        // --- ðŸ”´ KEYS START ---
        const DB_URL = 'https://zaofwxcizppmaqogssnx.supabase.co';
        const DB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inphb2Z3eGNpenBwbWFxb2dzc254Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NTM5MjMsImV4cCI6MjA4NDIyOTkyM30.BI-o4l5mJRy6EZRqSVT7Fe2j5ZWWVl6goPSlu-kJsJE';
        const VAPI_KEY = 'ce586be7-b4ca-44cc-8ee0-8ed25feb4562'; 
        const VAPI_ASSISTANT_ID = '645d3783-038d-423e-ab11-dda0c0ec6d5d';
        // --- KEYS END ---

        const db = window.supabase.createClient(DB_URL, DB_KEY);
        let myUser = null, uType = 'post';

        // 1. DATA LOADING
        async function loadData() {
            const { data: stories } = await db.from('stories').select('*, profiles(avatar)').order('created_at', { ascending: false });
            if(stories) {
                let html = document.getElementById('story-row').innerHTML.split('</div>')[0] + '</div>';
                const seen = new Set();
                stories.forEach(s => {
                    if(s.user_id !== myUser.id && !seen.has(s.user_id)) {
                        seen.add(s.user_id);
                        html += `<div style="text-align:center; flex-shrink:0;"><div class="s-ring active"><img src="${s.profiles.avatar}" class="s-img"></div><small style="font-size:10px;">User</small></div>`;
                    }
                });
                document.getElementById('story-row').innerHTML = html;
            }

            const { data: posts } = await db.from('posts').select('*, profiles(*)').order('created_at', { ascending: false });
            if(posts) {
                document.getElementById('feed').innerHTML = posts.map(p => `
                    <div class="post">
                        <div class="p-head" onclick="openProfile('${p.user_id}')">
                            <img src="${p.profiles?.avatar}" class="p-av"><b>${p.profiles?.username}</b>
                        </div>
                        <img src="${p.image}" class="p-img" ondblclick="like(this)">
                        <div class="p-act"><i class="ri-heart-3-line" onclick="like(this)"></i> <i class="ri-chat-3-line"></i></div>
                        <div style="padding:0 10px 10px;">${p.caption}</div>
                    </div>`).join('');
            }

            const { data: reels } = await db.from('reels').select('*, profiles(*)');
            if(reels) {
                document.getElementById('reels-screen').innerHTML = reels.map(r => `
                    <div class="reel">
                        <video src="${r.video_url}" class="r-vid" loop onclick="this.paused?this.play():this.pause()"></video>
                        <div class="r-ovl" onclick="openProfile('${r.user_id}')"><div style="display:flex;gap:10px;margin-bottom:5px;"><img src="${r.profiles?.avatar}" style="width:30px;height:30px;border-radius:50%;"><b>${r.profiles?.username}</b></div><p>${r.caption}</p></div>
                        <div class="r-side"><i class="ri-heart-3-line r-btn" onclick="like(this)"></i><i class="ri-share-forward-line r-btn"></i></div>
                    </div>`).join('');
            }
        }

        // 2. PROFILE & BUTTON LOGIC (FIXED)
        async function openProfile(targetId) {
            tab('profile');
            document.getElementById('back-btn').style.display = (targetId === myUser.id) ? 'none' : 'block';
            
            const { data: p } = await db.from('profiles').select('*').eq('id', targetId).single();
            if(p) {
                document.getElementById('p-name').innerText = p.username;
                document.getElementById('p-pic').src = p.avatar;
                if(targetId === myUser.id) document.getElementById('my-s-img').src = p.avatar;
            }

            // Stats
            const { count: postCount } = await db.from('posts').select('*', { count: 'exact' }).eq('user_id', targetId);
            const { count: fans } = await db.from('followers').select('*', { count: 'exact' }).eq('following_id', targetId);
            const { count: favs } = await db.from('followers').select('*', { count: 'exact' }).eq('follower_id', targetId);
            
            document.getElementById('s-posts').innerText = postCount || 0;
            document.getElementById('s-fans').innerText = fans || 0;
            document.getElementById('s-favs').innerText = favs || 0;

            const { data: posts } = await db.from('posts').select('*').eq('user_id', targetId);
            document.getElementById('p-grid').innerHTML = posts.map(p => `<img src="${p.image}" style="width:100%; aspect-ratio:1; object-fit:cover;">`).join('');

            // ðŸ”¥ BUTTON LOGIC
            const actDiv = document.getElementById('p-actions');
            actDiv.innerHTML = ""; // Clear old

            if(targetId === myUser.id) {
                actDiv.innerHTML = `<button onclick="logout()" class="p-btn btn-logout">Logout</button>`;
            } else {
                // Check if following, use try-catch to prevent crash if table missing
                try {
                    const { data } = await db.from('followers').select('*').eq('follower_id', myUser.id).eq('following_id', targetId);
                    if(data && data.length > 0) {
                        actDiv.innerHTML = `<button onclick="toggleFav('${targetId}')" class="p-btn btn-added">Favorited</button>`;
                    } else {
                        actDiv.innerHTML = `<button onclick="toggleFav('${targetId}')" class="p-btn btn-fav">Add to Favorites</button>`;
                    }
                } catch(e) {
                    console.log("DB Error (Table missing?)", e);
                    actDiv.innerHTML = `<button onclick="toggleFav('${targetId}')" class="p-btn btn-fav">Add to Favorites</button>`;
                }
            }
        }

        async function toggleFav(targetId) {
            const btn = document.querySelector('#p-actions button');
            const isAdded = btn.innerText === "Favorited";
            
            try {
                if(isAdded) {
                    await db.from('followers').delete().eq('follower_id', myUser.id).eq('following_id', targetId);
                    btn.innerText = "Add to Favorites"; btn.className = "p-btn btn-fav";
                    let fans = document.getElementById('s-fans'); fans.innerText = parseInt(fans.innerText) - 1;
                } else {
                    await db.from('followers').insert([{ follower_id: myUser.id, following_id: targetId }]);
                    btn.innerText = "Favorited"; btn.className = "p-btn btn-added";
                    let fans = document.getElementById('s-fans'); fans.innerText = parseInt(fans.innerText) + 1;
                }
            } catch(e) {
                alert("Please Run SQL in Supabase!");
            }
        }

        // 3. SEARCH
        async function doSearch(q) {
            if(!q) { document.getElementById('search-res').innerHTML=""; return; }
            const { data } = await db.from('profiles').select('*').ilike('username', `%${q}%`);
            if(data) document.getElementById('search-res').innerHTML = data.map(u => `
                <div class="user-row" onclick="openProfile('${u.id}')">
                    <img src="${u.avatar}"><b>${u.username}</b>
                </div>`).join('');
        }

        // 4. VAPI AI
        var vapiInstance = null; let aiOn = false;
        try{ if(typeof Vapi !== 'undefined') vapiInstance = new Vapi(VAPI_KEY); }catch(e){}

        function toggleVapi() {
            if(VAPI_KEY.includes('YOUR')) return alert("Vapi Key Missing");
            if(!vapiInstance && typeof Vapi !== 'undefined') vapiInstance = new Vapi(VAPI_KEY);
            
            const btn = document.getElementById('vapi-btn');
            if(aiOn) {
                if(vapiInstance) vapiInstance.stop(); 
                aiOn=false; btn.classList.remove('ai-active');
            } else {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
                    vapiInstance.start(VAPI_ASSISTANT_ID);
                    aiOn = true; btn.classList.add('ai-active');
                }).catch(()=>alert("Mic Blocked"));
            }
        }
        if(vapiInstance) {
            vapiInstance.on('message', (msg) => {
                if(msg.type==='transcript' && msg.transcriptType==='final') {
                    let c = msg.transcript.toLowerCase();
                    if(c.includes('home')) tab('home');
                    if(c.includes('profile')) openProfile(myUser.id);
                    if(c.includes('upload')) document.getElementById('upload-modal').classList.add('open');
                }
            });
        }

        // 5. UPLOAD & UTILS
        function setUType(t, el) { uType=t; document.querySelectorAll('.u-btn').forEach(b=>b.classList.remove('sel')); el.classList.add('sel'); }
        async function uploadNow() {
            let f = document.getElementById('u-file').files[0];
            let c = document.getElementById('u-cap').value;
            if(!f) return alert("Select File");
            let path = `${myUser.id}/${Date.now()}_${f.name.replace(/[^a-zA-Z0-9]/g,'')}`;
            const { error } = await db.storage.from('media').upload(path, f);
            if(!error) {
                const { data } = db.storage.from('media').getPublicUrl(path);
                let table = uType==='post'?'posts':uType==='reel'?'reels':'stories';
                let col = uType==='reel'?'video_url':'image';
                await db.from(table).insert([{ user_id: myUser.id, [col]: data.publicUrl, caption: c }]);
                document.getElementById('upload-modal').classList.remove('open');
                loadData();
            } else alert(error.message);
        }
        function like(el) { el.classList.toggle('ri-heart-3-line'); el.classList.toggle('ri-heart-3-fill'); el.classList.toggle('liked'); }
        function tab(t, el) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
            document.getElementById(t+'-screen').classList.add('active'); 
            if(el) { document.querySelectorAll('.nav i').forEach(i => i.classList.remove('active')); el.classList.add('active'); }
        }

        // 6. LOGIN
        function uiLogin(t) {
            document.getElementById('f-mail').style.display = t==='mail'?'block':'none';
            document.getElementById('f-sms').style.display = t==='sms'?'block':'none';
            document.getElementById('t-mail').className = t==='mail'?'tab active':'tab';
            document.getElementById('t-sms').className = t==='sms'?'tab active':'tab';
        }
        async function sendE() { let e=document.getElementById('e-in').value; const{error}=await db.auth.signInWithOtp({email:e}); if(!error){document.getElementById('e-s1').style.display='none';document.getElementById('e-s2').style.display='block';} }
        async function verifyE() { const{data,error}=await db.auth.verifyOtp({email:document.getElementById('e-in').value,token:document.getElementById('e-code').value,type:'email'}); if(!error){myUser=data.user;checkProfile();} }
        async function sendP() { let p=document.getElementById('p-in').value; const{error}=await db.auth.signInWithOtp({phone:p}); if(!error){document.getElementById('p-s1').style.display='none';document.getElementById('p-s2').style.display='block';} }
        async function verifyP() { const{data,error}=await db.auth.verifyOtp({phone:document.getElementById('p-in').value,token:document.getElementById('p-code').value,type:'sms'}); if(!error){myUser=data.user;checkProfile();} }

        async function init() { const {data:{session}} = await db.auth.getSession(); if(session){myUser=session.user;checkProfile();} }
        init();
        async function checkProfile() {
            let name = myUser.user_metadata.full_name || myUser.email?.split('@')[0] || "User";
            let pic = `https://ui-avatars.com/api/?name=${name}&background=00f2ea&color=000`;
            await db.from('profiles').upsert({ id: myUser.id, username: name, avatar: pic }, { onConflict: 'id', ignoreDuplicates: true });
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('app-view').style.display = 'flex';
            openProfile(myUser.id);
            loadData();
        }
        async function logout() { await db.auth.signOut(); location.reload(); }
    </script>
</body>
</html>
